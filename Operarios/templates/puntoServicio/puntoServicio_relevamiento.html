{% extends "base.html" %}

{% block content %}


<!--Aca inicia los mensajes personalizados -->
{% if form.non_field_errors %}
    <div class='container'>
        {% for error in form.non_field_errors %}
        <div class="alert alert-danger messages">Error: {{ error }}<br/></div>
        {% endfor %}
    </div>
{% endif %}



<div class='col mx-auto'>
{% if title %}<h1 class='my-3'>{{ title }}</h1>{% endif %}
<form method='POST' action='#' name='formulario' id='formulario'>
    <input type="hidden" id="action" name="action" value=""> 
    {% csrf_token %}
    
    <div class="container-fluid mb-4 mt-4">
        <div class="row mt-3">
            <div class="col-3"> {{ form.puntoServicio.label }} {{ form.puntoServicio }} </div>
            <div class="col"> {{ form.cantidad.label }} {{ form.cantidad }}</div>
            <div class="col"> {{ form.cantAprendices.label }} {{ form.cantAprendices }}</div>
            <div class="col-3"> {{ form.fechaInicio.label }} {{ form.fechaInicio }}</div>
        </div>
        <div class="row mt-3">
            <div class="col-4"> {{ form.cantidadHrTotal.label }} {{ form.cantidadHrTotal }}</div>
            <div class="col-4"> {{ form.cantidadHrEsp.label }} {{ form.cantidadHrEsp }}</div> 
            <div class="col-3"> {{ form.tipoSalario.label }} {{ form.tipoSalario }}</div>
        </div>
    </div>
    
    <!--Aca inicia los management_form -->
    {{ relevamDetFormSet.management_form }}
    {{ relevamEspFormSet.management_form }}
    {{ relevamCuHrFormSet.management_form }}
    {{ relevamMenFormSet.management_form }}

    <!--Formulario de Cupo de Horas-->
    <div class="container-fluid mb-3 mt-4" id='formset-CupoH'>
        <h4>
        Cupo de horas <small class="text-muted">Definicion de horas, frecuencia y tipo de Horas</small>
        </h4>
        <div class="row mt-3 mb-2 justify-content-end">
            <div class="col-3 text-right"> Total Cupo de Horas: </div>
            <div class="col-3">  <input id="sumAll_1" type="text" value="" class="form-control form-control-sm" readonly/></div>
        </div>
        <div class="row">
            <div class="col">Cantidad de Hrs </div>
            <div class="col">Frecuencia </div>
            <div class="col">Tipo de Horas </div>
            <div class="col-1">Eliminar? </div>
        </div>
	    {% for form in relevamCuHrFormSet %}
        {{ form.id }}
        <div class="row mt-2">
            <div class="col">
                {{ form.cantCHoras }}
            </div>
            <div class="col">
                {{ form.frecuencia }}
            </div>
            <div class="col">
                {{ form.tipoHora }}
            </div>
            <div class="col-1 text-center">
                {{ form.DELETE }}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="row mt-3 justify-content-end">
        <button id='btnCupH' class="btn btn-outline-info btn-sm">Añadir Cupo</button>
    </div>
    


    <!--Formulario de Servicios Particulares-->
    <div class="container-fluid mb-3 mt-4" id='formset-det'>
        <h4>
        Servicios Especificos <small class="text-muted">Definicion de dias y horario</small>
        </h4>
        <div class="row">
            <div class="col-2 p-0 mt-3"> Servicio </div>
            <div class="col p-0 text-center"> Lunes </div>
            <div class="col p-0 text-center"> Martes </div>
            <div class="col p-0 text-center"> Miercoles </div>
            <div class="col p-0 text-center"> Jueves </div>
            <div class="col p-0 text-center"> Viernes </div>
            <div class="col p-0 text-center"> Sabado </div>
            <div class="col p-0 text-center"> Domingo </div>
            <div class="col-1 p-0 text-center"> Eliminar? </div>
        </div>
	    {% for form in relevamDetFormSet %}
        {{ form.id }}
        <div class="row mt-2">
            <div class="col-2 p-0 mt-3">
                {{ form.tipoServPart }}
            </div>
            <div class="col p-0">
                {{ form.lunEnt }}{{ form.lunSal }}
            </div>
            <div class="col p-0">
                {{ form.marEnt }}{{ form.marSal }}
            </div>
            <div class="col p-0">
                {{ form.mieEnt }}{{ form.mieSal }}
            </div>
            <div class="col p-0">
                {{ form.jueEnt }}{{ form.jueSal }}
            </div>
            <div class="col p-0">
                {{ form.vieEnt }}{{ form.vieSal }}
            </div>
            <div class="col p-0">
                {{ form.sabEnt }}{{ form.sabSal }}
            </div>
            <div class="col p-0">
                {{ form.domEnt }}{{ form.domSal }}
            </div>
            <div class="col-1 p-0 text-center">
                {{ form.DELETE }}
            </div>
        </div>
        {% endfor %}

    </div>
    <div class="row mt-3 justify-content-end">
        <button type='submit' id='btnDet' class="btn btn-outline-info btn-sm" name='add_det'>Añadir Detalle</button>
    </div>
    

    <!--Formulario de Limpiezas Profundas-->
    <div class="container-fluid mb-3 mt-4" id='formset-Esp'>
        <h4>
        Limpiezas Profundas <small class="text-muted">Definicion de horas y frecuencia</small>
        </h4>
        <div class="row mt-3 mb-2 justify-content-end">
            <div class="col-3 text-right"> Total Horas Especiales: </div>
            <div class="col-3">  <input id="sumAll_2" type="text" value="" class="form-control form-control-sm" readonly/></div>
        </div>
        <div class="row">
            <div class="col">Tipo limpieza especial </div>
            <div class="col">Frecuencia </div>
            <div class="col">Día </div>
            <div class="col">Cantidad de Horas </div>
            <div class="col-1">Eliminar? </div>
        </div>
	    {% for form in relevamEspFormSet %}
        {{ form.id }}
        <div class="row mt-2">
            <div class="col">
                {{ form.tipo }}
            </div>
            <div class="col">
                {{ form.frecuencia }}
            </div>
            <div class="col">
                {{ form.dia }}
            </div>
            <div class="col">
                {{ form.cantHoras }}
            </div>
            <div class="col-1 text-center">
                {{ form.DELETE }}
            </div>
        </div>
        {% endfor %}

    </div>
    <div class="row mt-3 justify-content-end">
        <button type='submit' id='btnEsp' class="btn btn-outline-info btn-sm" name='add_esp'>Añadir Profundas</button>
    </div>

    <!--Formulario de Mensualeros-->
    <div class="container-fluid mb-3 mt-4" id='formset-Men'>
        <h4>
        Mensualeros <small class="text-muted">Definicion de cantidad y sueldos acordados</small>
        </h4>
        <div class="row">
            <div class="col-2">Cant. Mensualeros </div>
            <div class="col-2">Sueldo </div>
            <div class="col-1">Eliminar? </div>
        </div>
	    {% for form in relevamMenFormSet %}
        {{ form.id }}
        <div class="row mt-2">
            <div class="col-2">
                {{ form.mensuCantidad }}
            </div>
            <div class="col-2">
                {{ form.sueldo }}
            </div>
            <div class="col-1 text-center">
                {{ form.DELETE }}
            </div>
        </div>
        {% endfor %}

    </div>
    <div class="row mt-3 justify-content-end">
        <button id='btnMen' class="btn btn-outline-info btn-sm">Añadir Mensualero</button>
    </div>
    
    <div class="row mt-3">
        <div class="col"> {{ form.comentario.label }} {{ form.comentario }}</div>
    </div>

    <div class="row mt-5 justify-content-end">
        <button type='submit' class='btn btn-default btn-sm'>Guardar</button>
        <a class='btn btn-primary btn-sm' href={% url 'Operarios:puntoServicio_list' %}>Cancelar</a>
    </div>

</form>
</div>


  
<!-- Script que carga las filas dinamicamente -->
<script type='template/CupoHoras'>
    <div class="row mt-2">
        <div class="col">
            {{ relevamCuHrFormSet.empty_form.cantCHoras }}
        </div>
        <div class="col">
            {{ relevamCuHrFormSet.empty_form.frecuencia }}
        </div>
        <div class="col">
            {{ relevamCuHrFormSet.empty_form.tipoHora }}
        </div>
        <div class="col-1 text-center">
            {{ relevamCuHrFormSet.empty_form.DELETE }}
        </div>
    </div>
</script>

<script type='template/Detalle'>
    <div class="row mt-2">
            <div class="col-2 p-0 mt-3">
                {{ relevamDetFormSet.empty_form.tipoServPart }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.lunEnt }}{{ relevamDetFormSet.empty_form.lunSal }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.marEnt }}{{ relevamDetFormSet.empty_form.marSal }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.mieEnt }}{{ relevamDetFormSet.empty_form.mieSal }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.jueEnt }}{{ relevamDetFormSet.empty_form.jueSal }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.vieEnt }}{{ relevamDetFormSet.empty_form.vieSal }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.sabEnt }}{{ relevamDetFormSet.empty_form.sabSal }}
            </div>
            <div class="col p-0">
                {{ relevamDetFormSet.empty_form.domEnt }}{{ relevamDetFormSet.empty_form.domSal }}
            </div>
            <div class="col-1 p-0 text-center">
                {{ relevamDetFormSet.empty_form.DELETE }}
            </div>
        </div>
</script>


<script type='template/Especiales'>
    <div class="row mt-2">
            <div class="col">
                {{ relevamEspFormSet.empty_form.tipo }}
            </div>
            <div class="col">
                {{ relevamEspFormSet.empty_form.frecuencia }}
            </div>
            <div class="col">
                {{ relevamEspFormSet.empty_form.dia }}
            </div>
            <div class="col">
                {{ relevamEspFormSet.empty_form.cantHoras }}
            </div>
            <div class="col-1 text-center">
                {{ relevamEspFormSet.empty_form.DELETE }}
            </div>
        </div>  
</script>

<script type='template/Mensualeros'>
    <div class="row mt-2">
        <div class="col-2">
            {{ relevamMenFormSet.empty_form.mensuCantidad }}
        </div>
        <div class="col-2">
            {{ relevamMenFormSet.empty_form.sueldo }}
        </div>
        <div class="col-1 text-center">
            {{ relevamMenFormSet.empty_form.DELETE }}
        </div>
    </div>
</script>


</div>

<script>
/**
 * Number.prototype.format(n, x, s, c)
 * 
 * @param integer n: length of decimal
 * @param integer x: length of whole part
 * @param mixed   s: sections delimiter
 * @param mixed   c: decimal delimiter
 */
Number.prototype.format = function(n, x, s, c) {
    var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\D' : '$') + ')',
        num = this.toFixed(Math.max(0, ~~n));
    
    return (c ? num.replace('.', c) : num).replace(new RegExp(re, 'g'), '$&' + (s || ','));
};

function pad(d) {
    return (d < 10) ? '0' + d.toString() : d.toString();
}

function timeInHours(str){
   var sp = str.split(":");
   return parseInt(sp[0]) + parseFloat(sp[1]/60);
}

function hoursToString(h){
   var hours = Math.floor(h);
   var minutes = ((h - hours)*60).toFixed(2);

   return pad(hours) + ":" + pad(minutes);
}

function SumHrMin(h1, h2){
    var sp = h1.split(":");
    var hora1 = sp[0];
    var min1 = sp[1];

    sp = h2.split(":");
    var hora2 = sp[0];
    var min2 = sp[1];

    var hora_total = parseInt(hora1) + parseInt(hora2);
    var min_pre = parseInt(min1) + parseInt(min2);

    var horas_adicionales = Math.floor((min_pre/60));
    hora_total += horas_adicionales;
    var min_total = (min_pre - (horas_adicionales*60));

    return hora_total + ":" + pad(min_total);

}

function obtenerNumeroId(id){
    var sp = id.split("-");
    return sp[1];
}

$(function(){

    // Reemplaza todas las coincidencias en vez de solo la primera
    function replaceAll(text, busca, reemplaza){
          while (text.toString().indexOf(busca) != -1)
            text = text.toString().replace(busca, reemplaza);
          return text;
    }

    var $totalDetalle = $('#id_relevamientodet_set-TOTAL_FORMS');

    $('#btnDet').click(function(event) {
        event.preventDefault();
        var total = parseInt($totalDetalle.val(), 10);
        var clon = $('script[type="template/Detalle"]').html();
        clon_html = replaceAll(clon, '__prefix__', (total).toString());
        $('#formset-det').append(clon_html);
        $totalDetalle.val(total +  1);

        //Seteamos action
        document.getElementById('action').value = 'add_det';
        //hacemos submit
        document.getElementById('formulario').submit();
    });

    var $totalEspeciales = $('#id_relevamientoesp_set-TOTAL_FORMS');

    $('#btnEsp').click(function(event) {
        event.preventDefault();
        var total = parseInt($totalEspeciales.val(), 10);
        var clon = $('script[type="template/Especiales"]').html();
        clon_html = replaceAll(clon, '__prefix__', (total).toString());
        $('#formset-Esp').append(clon_html);
        $totalEspeciales.val(total +  1);

        //Seteamos action
        document.getElementById('action').value = 'add_esp';
        //hacemos submit
        document.getElementById('formulario').submit();
    });

    var $totalCupoHoras = $('#id_relevamientocupohoras_set-TOTAL_FORMS');

    $('#btnCupH').click(function(event) {
        event.preventDefault();
        var total = parseInt($totalCupoHoras.val(), 10);
        var clon = $('script[type="template/CupoHoras"]').html();
        clon_html = replaceAll(clon, '__prefix__', (total).toString());
        $('#formset-CupoH').append(clon_html);
        $totalCupoHoras.val(total +  1);
    });

    var $totalMensualeros = $('#id_relevamientomensualeros_set-TOTAL_FORMS');

    $('#btnMen').click(function(event) {
        event.preventDefault();
        var total = parseInt($totalMensualeros.val(), 10);
        var clon = $('script[type="template/Mensualeros"]').html();
        clon_html = replaceAll(clon, '__prefix__', (total).toString());
        $('#formset-Men').append(clon_html);
        $totalMensualeros.val(total +  1);
    });
});

$('input[id$="cantHoras"], [id$="frecuencia"]').on('change', function(e){
        debugger;
        //aqui empieza el calculo del total de horas especiales
        var total = 0;
        var subtotal = 0;
        $('input[id$="cantHoras"]').each(function() {
            if (!isNaN($(this).val()) && $(this).val() !== '') {

                var n = obtenerNumeroId(this.id);
                var frecuencia = $('#id_relevamientoesp_set-' + n + '-frecuencia').val();

                if(frecuencia == 'DIA'){
                    total += Number($(this).val())*30;
                }else if(frecuencia == 'SEM'){
                    total += Number($(this).val())*4;
                }else if(frecuencia == 'MEN'){
                    total += Number($(this).val());
                }else if(frecuencia == 'BIM'){
                    total += Number($(this).val())/2;
                }else if(frecuencia == 'TRI'){
                    total += Number($(this).val())/3;
                }else if(frecuencia == 'CUA'){
                    total += Number($(this).val())/4;
                }else if(frecuencia == 'SEL'){
                    total += Number($(this).val())/6;
                }else if(frecuencia == 'ANU'){
                    total += Number($(this).val())/12;
                }
                //total += Number($(this).val());
            }
        })
        total = hoursToString(total);
        $('#sumAll_2').val(SumHrMin(total, '00:00'));

        //aqui empieza el calculo del total de horas
        var total = 0;
        var sumaEsp = timeInHours($('#sumAll_2').val());
        total = hoursToString(sumaEsp);
        $('#id_cantidadHrEsp').val(SumHrMin(total, '00:00'));

    });

$('input[id$="cantCHoras"]').on('change', function(e){
        debugger;
        //aqui empieza el calculo del total de horas especiales
        var total = 0;
        var subtotal = 0;
        $('input[id$="cantCHoras"]').each(function() {
            if (!isNaN($(this).val()) && $(this).val() !== '') {

                total += Number($(this).val());

            }
        })
        total = hoursToString(total);
        $('#sumAll_1').val(SumHrMin(total, '00:00'));

        //aqui empieza el calculo del total de horas
        var total = 0;
        var sumaEsp = timeInHours($('#sumAll_1').val());
        total = hoursToString(sumaEsp);
        $('#id_cantidadHrTotal').val(SumHrMin(total, '00:00'));

    });

/*$('input[id$="sueldo"]').on('change', function(e){
        debugger;

        //aqui empieza el calculo del total de horas especiales
        var formateado = '';
        
        if (!isNaN($(this).val()) && $(this).val() !== '') {

            formateado = Number($(this).val()).format(0, 3, '.', ',');

        }
        $(this).val(formateado);

    });
*/


</script>

{% endblock %}